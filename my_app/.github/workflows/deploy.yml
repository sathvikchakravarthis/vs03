name: Deploy to Cloud Run

on:
push:
branches:
- main

jobs:
deploy:
permissions:
contents: read
id-token: write

```
runs-on: ubuntu-latest

steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Authenticate to Google Cloud
    uses: google-github-actions/auth@v2
    with:
      workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

  - name: Set up gcloud
    uses: google-github-actions/setup-gcloud@v2

  - name: Configure Docker
    run: gcloud auth configure-docker us-central1-docker.pkg.dev

  - name: Build and Push Image
    run: |
      IMAGE=us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-repo/my-app:${{ github.sha }}
      docker build -t $IMAGE .
      docker push $IMAGE

  - name: Deploy to Cloud Run
    run: |
      IMAGE=us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-repo/my-app:${{ github.sha }}
      gcloud run deploy my-app \
        --image $IMAGE \
        --region us-central1 \
        --platform managed \
        --allow-unauthenticated
```
