# # name: Deploy to Cloud Run

# # on:
# #   push:
# #     branches: [main]

# # jobs:
# #   deploy:
# #     permissions:
# #       contents: read
# #       id-token: write

# #     runs-on: ubuntu-latest

# #     steps:
# #       - name: Checkout
# #         uses: actions/checkout@v4

# #       - name: Authenticate to Google Cloud
# #         uses: google-github-actions/auth@v2
# #         with:
# #           workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
# #           service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

# #       - name: Set up gcloud
# #         uses: google-github-actions/setup-gcloud@v2

# #       - name: Configure Docker
# #         run: gcloud auth configure-docker us-central1-docker.pkg.dev

# #       - name: Build and Push Image
# #         run: |
# #           IMAGE=us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-repo/my-app:${{ github.sha }}
# #           docker build -t $IMAGE .
# #           docker push $IMAGE

# #       - name: Deploy to Cloud Run
# #         run: |
# #           IMAGE=us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-repo/my-app:${{ github.sha }}
# #           gcloud run deploy my-app \
# #             --image $IMAGE \
# #             --region us-central1 \
# #             --platform managed \
# #             --allow-unauthenticated




# # # This workflow will deploy source code on Cloud Run when a commit is pushed to
# # # the "main" branch.
# # #
# # # To configure this workflow:
# # #
# # # 1. Enable the following Google Cloud APIs:
# # #
# # #    - Artifact Registry (artifactregistry.googleapis.com)
# # #    - Cloud Build (cloudbuild.googleapis.com)
# # #    - Cloud Run (run.googleapis.com)
# # #    - IAM Credentials API (iamcredentials.googleapis.com)
# # #
# # #    You can learn more about enabling APIs at
# # #    https://support.google.com/googleapi/answer/6158841.
# # #
# # # 2. Create and configure a Workload Identity Provider for GitHub:
# # #    https://github.com/google-github-actions/auth#preferred-direct-workload-identity-federation.
# # #
# # #    Depending on how you authenticate, you will need to grant an IAM principal
# # #    permissions on Google Cloud:
# # #
# # #    - Artifact Registry Administrator (roles/artifactregistry.admin)
# # #    - Cloud Run Source Developer (roles/run.sourceDeveloper)
# # #
# # #    You can learn more about setting IAM permissions at
# # #    https://cloud.google.com/iam/docs/manage-access-other-resources.
# # #
# # # 3. Change the values in the "env" block to match your values.

# # name: 'Deploy to Cloud Run from Source'

# # on:
# #   push:
# #     branches:
# #       - main

# # env:
# #   PROJECT_ID: 'my-gcp-playground' # TODO: update to your Google Cloud project ID
# #   REGION: 'us-central1' # TODO: update to your region
# #   SERVICE: 'my-service' # TODO: update to your service name

# # jobs:
# #   deploy:
# #     runs-on: 'ubuntu-latest'

# #     permissions:
# #       contents: 'read'
# #       id-token: 'write'

# #     steps:
# #       - name: 'Checkout'
# #         uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # actions/checkout@v4

# #       # Configure Workload Identity Federation and generate an access token.
# #       #
# #       # See https://github.com/google-github-actions/auth for more options,
# #       # including authenticating via a JSON credentials file.
# #       - id: 'auth'
# #         name: 'Authenticate to Google Cloud'
# #         uses: 'google-github-actions/auth@f112390a2df9932162083945e46d439060d66ec2' # google-github-actions/auth@v2
# #         with:
# #           workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider' # TODO: replace with your workload identity provider

# #       - name: 'Deploy to Cloud Run'
# #         uses: 'google-github-actions/deploy-cloudrun@33553064113a37d688aa6937bacbdc481580be17' # google-github-actions/deploy-cloudrun@v2
# #         with:
# #           service: '${{ env.SERVICE }}'
# #           region: '${{ env.REGION }}'
# #           # NOTE: If using a different source folder, update the image name below:
# #           source: './'

# #       # If required, use the Cloud Run URL output in later steps
# #       - name: 'Show output'
# #         run: |-
# #           echo ${{ steps.deploy.outputs.url }}


# name: 'Deploy to Cloud Run from Source'

# on:
#   push:
#     branches:
#       - main

# env:
#   PROJECT_ID: 'my-gcp-playground-480411'
#   REGION: 'asia-south1' # Mumbai
#   SERVICE: 'github-deploy' # change this to your Cloud Run service name

# jobs:
#   deploy:
#     runs-on: 'ubuntu-latest'

#     permissions:
#       contents: 'read'
#       id-token: 'write'

#     steps:
#       - name: 'Checkout'
#         uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # actions/checkout@v4

#       - id: 'auth'
#         name: 'Authenticate to Google Cloud'
#         uses: 'google-github-actions/auth@f112390a2df9932162083945e46d439060d66ec2' # google-github-actions/auth@v2
#         with:
#           workload_identity_provider: 'projects/321364396036/locations/global/workloadIdentityPools/github-pool2/providers/github-pool2'
#           service_account: 'github-deployer@my-gcp-playground-480411.iam.gserviceaccount.com'

#       - id: 'deploy'
#         name: 'Deploy to Cloud Run'
#         uses: 'google-github-actions/deploy-cloudrun@33553064113a37d688aa6937bacbdc481580be17' # google-github-actions/deploy-cloudrun@v2
#         with:
#           service: '${{ env.SERVICE }}'
#           region: '${{ env.REGION }}'
#           source: './'

#       - name: 'Show output'
#         run: |-
#           echo "${{ steps.deploy.outputs.url }}"
 

name: Deploy to Cloud Run (Source)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

concurrency:
  group: cloudrun-${{ github.ref }}
  cancel-in-progress: true

env:
  PROJECT_ID: "my-gcp-playground-480411"
  REGION: "asia-south1"
  SERVICE: "github-deploy"

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      # (Optional) quick debug to confirm repo/ref in logs
      - name: Debug GitHub context
        run: |
          echo "repo=${{ github.repository }}"
          echo "ref=${{ github.ref }}"
          echo "sha=${{ github.sha }}"

      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

      - name: Authenticate to Google Cloud (OIDC)
        id: auth
        uses: google-github-actions/auth@f112390a2df9932162083945e46d439060d66ec2 # v2
        with:
          workload_identity_provider: "projects/321364396036/locations/global/workloadIdentityPools/github-pool2/providers/github-pool2"
          service_account: "github-deployer@my-gcp-playground-480411.iam.gserviceaccount.com"
          token_format: "access_token"

      # Not strictly required for deploy-cloudrun, but useful for debugging & consistency
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@b9c1f06fdd7f2c06b6b2f21d18c7b6a76ed2a22c # v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to Cloud Run (from source)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@33553064113a37d688aa6937bacbdc481580be17 # v2
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          project_id: ${{ env.PROJECT_ID }}
          # source: "./"
          source: "./my_app"

          # Optional: set once and keep stable; avoids surprises:
          flags: >
            --allow-unauthenticated
            --port=8080
            --min-instances=0
            --max-instances=3
            --cpu=1
            --memory=512Mi

      - name: Show Service URL
        run: echo "${{ steps.deploy.outputs.url }}"
